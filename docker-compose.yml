services:
  # --- Reverse Proxy (Traffic Management) ---
  traefik:
    image: traefik:v3.0
    restart: always
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8090:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - nexnet

  # --- Database (PostgreSQL) ---
  db:
    image: postgres:17
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-nexpyrs}" ]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    volumes:
      - nexpyrs-db-data:/var/lib/postgresql/data/pgdata
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-nexpyrs}
    networks:
      - nexnet

  # --- PgAdmin (Database Management) ---
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-admin@nexpyrs.dev}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-admin}
    depends_on:
      - db
    networks:
      - nexnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.localhost`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"

  # --- Frontend (Next.js) ---
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    restart: always
    # ports:  # Uncomment for direct access (bypassing Traefik)
    #   - "3000:3000"
    networks:
      - nexnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

  # --- FastAPI Backend ---
  api:
    build:
      context: ./api
      dockerfile: Dockerfile.fastapi
    restart: always
    # ports:  # Uncomment for direct access (bypassing Traefik)
    #   - "8000:8000"
    environment:
      - PROJECT_NAME=${PROJECT_NAME:-NexPyRS}
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=${POSTGRES_DB:-nexpyrs}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - nexnet
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/docs" ]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.localhost`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=8000"

  # --- Django Application ---
  django:
    build:
      context: ./api
      dockerfile: Dockerfile.django
    restart: always
    # ports:  # Uncomment for direct access (bypassing Traefik)
    #   - "8001:8000"
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=${POSTGRES_DB:-nexpyrs}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - nexnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.django.rule=Host(`django.localhost`)"
      - "traefik.http.routers.django.entrypoints=web"
      - "traefik.http.services.django.loadbalancer.server.port=8000"

  # --- gRPC Service ---
  grpcsvc:
    build: ./grpcsvc
    restart: always
    networks:
      - nexnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grpcsvc.rule=Host(`grpc.localhost`)"
      - "traef ik.http.routers.grpcsvc.entrypoints=web"
      - "traefik.http.services.grpcsvc.loadbalancer.server.port=50051"

  # --- Rust Microservice ---
  rustsvc:
    build: ./rustsvc
    restart: always
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db/${POSTGRES_DB:-nexpyrs}
    networks:
      - nexnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rustsvc.rule=Host(`rust.localhost`)"
      - "traefik.http.routers.rustsvc.entrypoints=web"
      - "traefik.http.services.rustsvc.loadbalancer.server.port=8080"

  # --- Jenkins CI/CD ---
  jenkins:
    image: jenkins/jenkins:lts
    restart: always
    user: root
    volumes:
      - jenkins-data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - nexnet
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jenkins.rule=Host(`jenkins.localhost`)"
      - "traefik.http.routers.jenkins.entrypoints=web"
      - "traefik.http.services.jenkins.loadbalancer.server.port=8080"

volumes:
  nexpyrs-db-data:
  jenkins-data:


networks:
  nexnet:
    driver: bridge
